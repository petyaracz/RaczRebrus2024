---
title: "The linking vowel should be lexically specified: Evidence from Hungarian"
author: "Rácz, Péter"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}

# -- setup -- #

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.path = 'figures/', fig.width = 8, fig.height = 8)
# set wd in md
knitr::opts_knit$set(root.dir = '~/Github/RaczRebrus2024/')
setwd('~/Github/RaczRebrus2024/')

set.seed(1338)
options(knitr.kable.NA = "")

# -- pack -- #

library(tidyverse)
library(glue)
library(magrittr)
library(patchwork)
library(ggthemes)
library(knitr)
library(mgcv)

# -- fun -- #

# -- read -- #

# filtered AE stems with 30 most frequent suffixes, one suffixed form per row: 
# bojler; bojlertóől
# bojler; bojlertől
l = read_tsv('dat/dat_long.tsv')
# same, but one pair of back front suffixes per row
# bojler; bojlertól / bojlertől
w = read_tsv('dat/dat_wide.tsv')
# same, but only suffixes that show variation (at least 1 of back and front for each given stem+suffix)
r = read_tsv('dat/dat_wide_v.tsv')
# KNN model w/ K==1, sort of, based on jaccard distance and levenshtein distance
# categories: log odds back / front > 0 high, else low
# LOO and then contingency table
c = read_tsv('dat/knn_stats.tsv')

# -- munging -- #

# get postag frequencies for later sorting
xpostag_levels = l %>% 
  group_by(xpostag,examples) %>% 
  summarise(tagfreq = sum(freq)) %>% 
  ungroup() %>% 
  mutate(xpostag = fct_reorder(xpostag, -tagfreq)) %>% 
  pull(xpostag) %>% 
  levels()

```

## Background

Hungarian suffixation shows vowel harmony. Noun postpositions typically have back- and front-suffix variants which are selected to agree with the last vowel of the stem: "Rómában" (Rome.loc), "Berlinnek" (Berlin.dat).

Historically, [eéií] are transparent and skipped by vowel harmony: "Tallinban" (Tallin.loc), "Maléban" (Malé.loc). [e] has become variable, meaning that back vowel + [e] stems vary between back and front suffixes: "Tangernek" (Tanger.dat).

1. Is variation sensitive to the stem?
2. Is variation sensitive to the suffix?
3. How should variation be lexically specified?

## Methods

We compiled a frequency list from the Hungarian Webcorpus 2 (Nemeskey 2020). The Webcorpus contains 18279298 types and 8570080167 tokens. We filtered the frequency list to include noun forms of two syllables with a back vowel and [e]. We used a spellchecker (Ooms 2022) and hand-filtering to winnow the list. We picked the 30 most common postpositions (noun suffixes) that co-occur with these nouns. The resulting list has `r length(unique(l$lemma))` stems and `r nrow(l)` suffixed forms.

A sample of the data for the stem "dzsungel" (jungle) can be seen below:

```{r dzsungel1}
dzsungel1 = l %>% 
  filter(lemma == 'dzsungel') %>% 
  mutate(xpostag = fct_relevel(xpostag, xpostag_levels)) %>% 
  select(xpostag,form,freq,examples) %>% 
  arrange(xpostag,-freq) %>% 
  slice(1:17)

dzsungel2 = dzsungel1 %>% 
  pull(xpostag)

dzsungel1 %>%
  kable('simple', caption = 'Sample long data for "dzsungel"')
```

Note that the stem shows back / front variation with most suffix tags (such as the inessive: "dzsungelben" n = 10604, "dzsungelban" n = 258, "in the jungle") but not all of them. For example, no back variant of the 1pl.poss is attested ("dzsungelünk" n = 39, "dzsungelunk" n = 0, "our jungle).

We restricted the data to suffixed forms that do show back / front variation in the corpus, resulting in `r length(unique(r$lemma))` stems and `r nrow(r)` suffixed forms. We went on to calculate the log odds ratio of back and front forms for each suffixed form. A sample of the resulting data for "dzsungel" can be seen below:

```{r dzsungel2}

r %>% 
  filter(
    lemma == 'dzsungel',
    xpostag %in% xpostag_levels
         ) %>% 
  mutate(
    xpostag = fct_relevel(xpostag, xpostag_levels),
    log_odds_back = log( back / front )
         ) %>% 
  arrange(xpostag,log_odds_back) %>% 
  select(xpostag,back,front,log_odds_back) %>% 
  kable('simple', caption = 'Sample wide data for "dzsungel"', digits = 2)

```

We wanted to gauge the extent of variation for each stem Summing over the back / front suffixed forms per stem across all postags does not provide an accurate picture of this because the suffixes themselves vary in both raw frequency and the ratio of back / front forms. Instead, following Janda, Nesset & Baayen (2010), we fit a Generalised Linear Mixed Model (Bates 2015) predicting the proportion of back / front forms, estimating only an overall intercept as well as a random intercept (grouping factor) for each stem and each suffix type. We then extracted the stem intercept and used this instead of the log odds of total counts per stem We did this across all suffixed forms, as well as only for consonant-initial and vowel-initial suffixes, respectively. As a result, we have three numbers per stem to express how these vary (a) in total, (b) with consonant-initial suffixes, (c) with vowel-initial suffixes. We justify this split below.

We wanted to know whether form-based similarity drives variation across stems In order to find out, we split the stems in two categories: "back" if the stem intercept was above 0 and "front" if it was equal to or below 0. We went on to take all varying stems, transcribe them using a simple segment-to-character script, calculated Levenshtein distances between each possible pair of stems, and then used the resulting distance matrix to fit a very simple K-nearest neighbours model. The model takes each form as a target form, identifies all other forms with the smallest Levenshtein distance to the target form, and then makes a category prediction for the target form based on the majority label in this filtered training set of nearest neighbours.

## Results

The resulting data look like this:

```{r ranef}
r %>%
  filter(!is.na(ranef_c),!is.na(ranef_v)) %>% 
  distinct(lemma,ranef_l,ranef_c,ranef_v) %>% 
  arrange(ranef_l) %>% 
  mutate(ntile = ntile(ranef_l, 10)) %>% 
  group_by(ntile) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(-ntile) %>% 
  rename(
    'stem' = lemma,
    'intercept' = ranef_l,
    'C intercept' = ranef_c,
    'V intercept' = ranef_v
  ) %>% 
  kable('simple', caption = 'Random intercepts based on all suffixed forms, C-initial suffixes only, and V-initial suffixes only.', digits = 2)
```

Since the intercept values come from models predicting log odds, these themselves can be very roughly interpreted as expressing log odds ratios. This, in turn, means that, even in the set of lemmata that show back / front variation, some lemmata have an extreme preference for back or front suffixes. This can be seen in the figure below:

```{r ranef2, fig.width = 8, fig.height = 4}
rq = r %>% 
  distinct(lemma,ranef_l) %>% 
  mutate(
    lower = quantile(ranef_l, .25),
    upper = quantile(ranef_l, .75)
  )

rq %>% 
  ggplot(aes(ranef_l)) +
  geom_histogram(bins = 50) +
  geom_vline(aes(xintercept = lower), lty = 3) +
  geom_vline(aes(xintercept = upper), lty = 3) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  theme_bw() +
  scale_x_continuous(sec.axis = sec_axis(trans = ~ plogis(.), breaks = c(.01,.05,.1,.25,.5,.75,.9,.95,.1), name = 'random intercept (stem)\np (back)'), name = 'random intercept (stem)\nlog odds (back/front)', breaks = c(-5:5)) +
  ggtitle('Stem random intercepts as log odds / probabilities for varying stems in the corpus')
```

50% of the stems are either below p = `r round(plogis(unique(rq$lower)),2)` or above p = `r round(plogis(unique(rq$upper)),2)`.

### Is variation tied to the stem?

We used our simple nearest neighbours model to see whether form-based similarity predicts stem behaviour. Recall that we split the stems into two discrete categories, "back" (above 0 in the figure above) and "front" (below zero in the figure above). We then used the closest stems for each stem (excluding the stem itself) to predict what category the stem should be in. If this simple method can predict stem behaviour with an accuracy that is above chance, that strongly suggests that stems that look a certain way behave a certain way.

Model predictions are significantly correlated with category labels (Chisq = `r round(c[c$name == 'lv',]$statistic,2)`, p > 0.0001). This means that stem-level variation is not arbitrary -- it is predicted by the phonological attributes of the stem.

One explanation for this stem-level specification of variation is diachronic (Forró 2013). Back vowel + [e] nouns that entered the language primarily in writing are much more likely to prefer front-suffixes, while those that were borrowed in the spoken register prefer back-suffixes. This can be illustrated by a sample of the stems that show strongest back- versus front-preference.

```{r stems}

rq2 = r %>% 
  distinct(lemma,ranef_l) %>% 
  arrange(ranef_l) %>% 
  slice(1:5,(n()-5):n()) %>% 
  rename(
    'stem' = lemma,
    'intercept' = ranef_l
  ) %>% 
  mutate(p = plogis(intercept)) 

rq2 %>% 
  kable('simple', digits = 3, caption = 'Top five and bottom five variable stems in the corpus')

```

The top 5 forms (with a very low intercept, that is, a very strong preference for front forms) are all learned borrowings (`r rq2 %>% head(5) %>% pull(stem)`). In contrast, the five bottom forms are all informal (`r rq2 %>% tail(5) %>% pull(stem)`): these are either borrowings with a considerable semantic shift ("balek", meaning "gullible idiot", comes from Turkish "balık", "fish", "haver", meaning "pal", comes from Hebrew "חבר", "friend", "fater", meaning "daddy", comes from German "Vater", meaning "father").

### Is variation tied to the suffix?

Stem-based variation shows an apparent asymmetry across consonant-initial versus vowel-initial suffixes. This can be seen in the table below, which shows a subset of suffixed forms for the "back" stem "haver" and the "front" stem "koncert".

```{r haverkoncert}
l %>% 
  filter(
    lemma %in% c('haver','koncert'),
    str_detect(xpostag, '(?<=\\[\\/N\\]\\[)(Del|Subl|Pl|Supe)(?=[^\\.])')
         ) %>% 
  arrange(lemma,suffix_initial,xpostag) %>%
  select(lemma,form,xpostag,suffix_vowel,suffix_initial,freq) %>% 
  kable('simple', caption = 'Delative, plural, sublative, and superlative suffixed forms for "haver" and "koncert"')

```

When we look at "haver", we see that it overwhelmingly prefers back suffixes (as expected). In addition, this is even more marked with V-initial versus C-initial suffixes. For instance, the back-front ratio for the C-initial delative is 62/15. In contrast, for the V-initial superessive, it is 51/1. The behaviour of "koncert", which has an overall "front" preference with the C-initial suffixes, has a "front" / "back" ratio of 86590 / 4 for the superessive, and is not attested in the corpus with a back vowel in the delative and the plural at all.

Even within the set of stems that do vary with at least one C-initial and V-initial suffix, this overall trend is visible. This can be seen in the figure below:

```{r suffix, fig.width = 8, fig.height = 12}

r %>% 
  filter(!is.na(ranef_c_minus_v)) %>% 
  distinct(lemma,ranef_c_minus_v,ranef_c,ranef_v) %>% 
  rename(
    'C-initial' = ranef_c,
    'V-initial' = ranef_v
  ) %>% 
  mutate(
    category = case_when(
      ranef_c_minus_v > 0 ~ 'C > V',
      ranef_c_minus_v <= 0 ~ 'V < C'
    ) %>% 
      fct_relevel('V < C')
  ) %>% 
  pivot_longer(-c(lemma,ranef_c_minus_v,category)) %>% 
  mutate(
    name = fct_relevel(name, 'V-initial')
  ) %>% 
  ggplot(aes(name,value,label = lemma,group = lemma)) +
  geom_line() +
  geom_label(position = position_jitter(height = 0, width = .2)) +
  theme_bw() +
  facet_wrap( ~ category) +
  xlab('') +
  scale_y_continuous(sec.axis = sec_axis(trans = ~ plogis(.), breaks = c(.01,.05,.1,.25,.5,.75,.9,.95,.1), name = 'random intercept (stem)\np (back)'), name = 'random intercept (stem)\nlog odds (back/front)', breaks = c(-5:5)) +
  ggtitle('Back/front preference for variable stems across C-initial and V-initial suffixes')

```

The figure is split into two panels for the sake of legibility. The left panel shows stems that show a stronger back-preference with V-initial versus C-initial suffixes, the right panel, the other way round. In each panel, the two columns show the V-initial and the C-initial random intercept for the stem. Each line expresses the ratio of back preference with V- versus C-initial suffixes. For "haver", seen on top in the left, this is very much a positive relationship. For "koncert", seen at the bottom in the right, this is a weaker negative relationship.

What we see is an interactive, rather than additive, relationship between stem-level and suffix-level variation. If the stem prefers back suffixes, this is more pronounced with vowel-initial suffixes. If it prefers front suffixes, this, in turn, is more pronounced with vowel-initial suffixes.

We can express this relationship in two steps. First, we can subtract the V-initial random intercept from the C-initial random intercept to express the ratio of the two. This will be a larger, negative value for "haver" (where the C intercept is smaller than the V intercept) and a smaller, positive value for "koncert" (where the C intercept is larger than the V intercept). We can then plot this value against the overall stem preference for back / front suffixes. The resulting figure can be seen below:

```{r suffix2, fig.width = 9, fig.height = 9}
r %>% 
  filter(!is.na(ranef_c_minus_v)) %>% 
  distinct(lemma,ranef_l,ranef_c_minus_v) %>% 
  ggplot(aes(ranef_l,ranef_c_minus_v, label = lemma)) +
  ggrepel::geom_label_repel() +
  geom_smooth() +
  xlab('overall stem preference') +
  ylab('C preference - V preference') +
  theme_bw()
```

We find a non-linear relationship.  Stems that show a strong preference for "front" suffixes show this about equally with C- and V-initial suffixes. Stems that show a strong preference for "back" suffixes (the "haver" category discussed above) show an exacerbated preference with V-initial suffixes.

We can test this relationship by fitting three generalised additive models (Wood 2011), predicting C-V preference from overall preference across variable stems, using Maximum Likelihood, estimating (i) an intercept only, (ii) a linear relationship, (iii) a smooth (k = 3) and seeing which model provides the best fit. The best model, as seen in Figure below, is (iii).

```{r gam, fig.width = 4, fig.height = 4}
r2 = r %>% 
  filter(!is.na(ranef_c_minus_v)) %>% 
  distinct(lemma,ranef_l,ranef_c_minus_v)

fit1 = gam(ranef_c_minus_v ~ 1, data = r2, method = 'ML')
fit2 = gam(ranef_c_minus_v ~ 1 + ranef_l, data = r2, method = 'ML')
fit3 = gam(ranef_c_minus_v ~ 1 + s(ranef_l, k = 3, bs = 'ts'), data = r2, method = 'ML')

# performance::test_likelihoodratio(fit1,fit3)
# performance::test_likelihoodratio(fit2,fit3)
plot(performance::compare_performance(fit1,fit2,fit3, metrics = 'common'))

```

The predicted relationship can be seen in the figure below:

```{r gam2, fig.width = 4, fig.height = 4}
plot(fit3, xlab = 'stem intercept', ylab = 'C - V')
```

This shows that stem-level preference has a significant relationship with the change between V- and C-preference across variable stems. That is, V-initial suffixes magnify the pre-existing pattern.

```{r suffixes, fig.height = 4, fig.width = 10}
plots = l %>% 
  group_by(xpostag,examples,suffix_initial) %>% 
  summarise(f = sum(freq)) %>% 
  ungroup() %>% 
  mutate(
    log10_freq = log10(f),
    tag = glue::glue('{xpostag} ({examples})'),
    tag = fct_reorder(tag, f),
    cat = glue::glue('{suffix_initial}-initial')
         ) %>% 
  group_by(cat) %>% 
  nest() %>% 
  mutate(
    plot = map2(
      data, cat, ~ {
        .x %>% 
          ggplot(aes(log10_freq,tag)) +
          geom_point() +
          theme_bw() +
          ggtitle(.y) +
          ylab('') +
          xlab('log10 frequency in sample') +
          xlim(3.5,6.5)
      }
    )
  ) %>% 
  pull(plot)

wrap_plots(plots)

```

What we see is that V-initial suffixes are both more variable in frequency than C-initial suffixes and that, in particular, the two most frequent V-suffixes are much more frequent than the rest of them. In contrast, variation is more normal for C-suffixes. That ought to count for something these days.